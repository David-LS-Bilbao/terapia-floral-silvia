--- 
import Logo from "./Logo.astro";

// Evita falsos positivos de TS en VS Code con import.meta.env
const base = (import.meta as any).env?.BASE_URL || "/";

// Normaliza con barra final para comparar correctamente
// @ts-ignore
const normalize = (p: string) => (p.endsWith("/") ? p : p + "/");

// Ruta actual (incluye el base en GitHub Pages)
// @ts-ignore
const here = normalize(Astro.url.pathname);

// Links del sitio (añade/quita según tus páginas)
const links = [
  { href: normalize(`${base}hero-b/`),         label: "Inicio" },
  { href: normalize(`${base}servicios/`),      label: "Servicios" },
  { href: normalize(`${base}tarifas/`),        label: "Tarifas" },
  { href: normalize(`${base}contacto/`),       label: "Contacto" },
  // { href: normalize(`${base}flores/`),      label: "Flores de Bach" }, // cuando la habilites
];

// Helper para aplicar estilos de enlace activo
const isActive = (href: string) => here === href;
---
<header class="bg-[#FFF7F1]/80 backdrop-blur supports-[backdrop-filter]:bg-[#FFF7F1]/60 border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
   
    <!-- Logo / Marca -->
    <a href={`${base}hero-b/`} class="flex items-center gap-3 font-semibold text-slate-800" aria-label="Ir al inicio">
      <Logo size="small" priority={true} />
      <span class="hidden sm:inline">Terapias Naturales - Silvia Adame</span>
      <span class="sm:hidden">Silvia Adame</span>
    </a>

    <!-- Navegación Desktop -->
    <nav class="hidden md:flex items-center gap-5 text-sm" aria-label="Principal">
      {/* @ts-ignore */}
      {links.map((l) => (
        <a
          href={l.href}
          class={`px-1 py-2 transition-colors hover:underline ${
            isActive(l.href) ? "text-slate-900 font-semibold underline" : "text-slate-700"
          }`}
          aria-current={isActive(l.href) ? "page" : undefined}
        >
          {l.label}
        </a>
      ))}
    </nav>

    <!-- Botón hamburguesa móvil -->
    <button 
      data-mobile-menu-toggle
      class="md:hidden flex flex-col items-center justify-center w-8 h-8 space-y-1 z-[110] relative"
      aria-label="Abrir menú de navegación"
      aria-expanded="false"
    >
      <span class="mobile-menu-line w-6 h-0.5 bg-slate-700 transition-all duration-300 origin-center"></span>
      <span class="mobile-menu-line w-6 h-0.5 bg-slate-700 transition-all duration-300 origin-center"></span>
      <span class="mobile-menu-line w-6 h-0.5 bg-slate-700 transition-all duration-300 origin-center"></span>
    </button>
  </div>

  <!-- Menú móvil overlay -->
  <div 
    data-mobile-menu-overlay
    class="fixed inset-0 bg-slate-900/95 backdrop-blur-sm z-[100] opacity-0 invisible pointer-events-none transition-all duration-300 md:hidden"
    aria-hidden="true"
  >
    <nav 
      data-mobile-menu-panel
      class="absolute top-0 right-0 h-full w-72 bg-white/95 supports-[backdrop-filter]:backdrop-blur-md shadow-xl shadow-slate-800/10 border-l border-slate-200 transform translate-x-full transition-transform duration-300"
      aria-label="Navegación móvil"
      aria-hidden="true"
    >
      <!-- Header del menú móvil -->
      <div class="bg-gradient-to-r from-[#3B755F] to-[#9FB8AD] px-6 py-5 text-white">
        <h2 class="text-lg font-semibold">Navegación</h2>
        <p class="text-sm opacity-90">Terapias Naturales</p>
      </div>
      
      <div class="p-6">
        {/* @ts-ignore */}
        {links.map((l) => (
          <a
            href={l.href}
            data-mobile-menu-link
            class={`block py-4 px-5 mb-3 rounded-xl text-lg font-medium transition-all duration-200 ${
              isActive(l.href) 
                ? "bg-[#3B755F] text-white shadow-lg scale-105" 
                : "text-slate-800 hover:bg-[#9FB8AD]/20 hover:text-[#3B755F] hover:scale-102"
            }`}
            aria-current={isActive(l.href) ? "page" : undefined}
          >
            {l.label}
          </a>
        ))}
      </div>
    </nav>
  </div>
</header>

<script>
  // Menú móvil (vanilla JS, sin tipos TS para compatibilidad en navegador)
  (function () {
    // Guardamos la instancia en window para evitar doble inicialización
    if (typeof window === 'undefined') return;
    if (window.__mobileMenuInit) return;
    window.__mobileMenuInit = true;

    const button = document.querySelector('[data-mobile-menu-toggle]');
    const overlay = document.querySelector('[data-mobile-menu-overlay]');
    const panel = document.querySelector('[data-mobile-menu-panel]');
    const lines = document.querySelectorAll('.mobile-menu-line');
    if (!button || !overlay || !panel) {
      if (import.meta && import.meta.env && import.meta.env.DEV) {
        console.warn('Mobile menu: elementos no encontrados');
      }
      return;
    }

    let isOpen = false;

    function openMenu() {
      if (isOpen) return;
      isOpen = true;

      // overlay visible
      overlay.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
      overlay.classList.add('opacity-100', 'visible', 'pointer-events-auto');
      overlay.setAttribute('aria-hidden', 'false');

      // panel visible
      panel.classList.remove('translate-x-full');
      panel.classList.add('translate-x-0');
      panel.setAttribute('aria-hidden', 'false');

      // aria-expanded
      button.setAttribute('aria-expanded', 'true');

      // animación hamburguesa -> X (usar translateY para suavizar)
      if (lines && lines.length >= 3) {
        lines[0].style.transform = 'rotate(45deg) translateY(7px)';
        lines[1].style.opacity = '0';
        lines[2].style.transform = 'rotate(-45deg) translateY(-7px)';
      }

      // bloquear scroll fondo
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      if (!isOpen) return;
      isOpen = false;

      // overlay hidden
      overlay.classList.add('opacity-0', 'invisible', 'pointer-events-none');
      overlay.classList.remove('opacity-100', 'visible', 'pointer-events-auto');
      overlay.setAttribute('aria-hidden', 'true');

      // panel hidden
      panel.classList.add('translate-x-full');
      panel.classList.remove('translate-x-0');
      panel.setAttribute('aria-hidden', 'true');

      // aria-expanded
      button.setAttribute('aria-expanded', 'false');

      // restaurar hamburguesa
      if (lines) {
        lines.forEach(line => {
          line.style.transform = '';
          line.style.opacity = '';
        });
      }

      // restaurar scroll
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
    }

    function toggleMenu(e) {
      e && e.preventDefault();
      if (isOpen) closeMenu(); else openMenu();
    }

    // listeners
    button.addEventListener('click', toggleMenu);

    overlay.addEventListener('click', function (e) {
      if (e.target === overlay) closeMenu();
    });

    // cerrar al clicar en un enlace
    overlay.querySelectorAll('[data-mobile-menu-link]').forEach(a => {
      a.addEventListener('click', () => {
        // small delay so user sees UI feedback before navigation
        closeMenu();
      });
    });

    // escape
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && isOpen) closeMenu();
    });

    // cerrar al volver a desktop
    window.addEventListener('resize', function () {
      if (window.innerWidth >= 768 && isOpen) closeMenu();
    });

    // Si usas navegación SPA de Astro, reinicializa cuando sea necesario
    document.addEventListener('astro:page-load', function () {
      // nothing to do; element references stay the same, but ensure closed state
      if (isOpen) closeMenu();
    });
  })();
</script>

<style>
  /* Mejoras CSS para animaciones más suaves */
  [data-mobile-menu-overlay] {
    transition: opacity 0.28s ease-in-out, visibility 0.28s ease-in-out;
  }
  
  [data-mobile-menu-panel] {
    transition: transform 0.32s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .mobile-menu-line {
    transform-origin: center;
    transition: transform 0.28s cubic-bezier(0.4, 0, 0.2, 1), 
                opacity 0.28s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Asegurar que el botón esté por encima del overlay */
  [data-mobile-menu-toggle] {
    position: relative;
    z-index: 110;
  }
  
  /* Asegurar que el overlay tenga z-index alto */
  [data-mobile-menu-overlay] {
    z-index: 100;
  }
  
  [data-mobile-menu-panel] {
    z-index: 101;
  }

  /* Modo oscuro para el panel móvil */
  @media (prefers-color-scheme: dark) {
    [data-mobile-menu-panel] {
      background: linear-gradient(180deg, rgba(8,10,12,0.92), rgba(18,20,22,0.95));
      color: #fff;
      border-left-color: rgba(255,255,255,0.06);
    }
    [data-mobile-menu-panel] a {
      color: #e6f6ef;
    }
    [data-mobile-menu-panel] a:hover {
      color: #d5f0e3;
    }
  }
</style>








