---
import Logo from "./Logo.astro";

// Evita falsos positivos de TS en VS Code con import.meta.env
const base = (import.meta as any).env?.BASE_URL || "/";

// Normaliza con barra final para comparar correctamente
// @ts-ignore
const normalize = (p: string) => (p.endsWith("/") ? p : p + "/");

// Ruta actual (incluye el base en GitHub Pages)
// @ts-ignore
const here = normalize(Astro.url.pathname);

// Links del sitio (añade/quita según tus páginas)
const links = [
  { href: normalize(`${base}hero-b/`),         label: "Inicio" },
  { href: normalize(`${base}servicios/`),      label: "Servicios" },
  { href: normalize(`${base}contacto/`),       label: "Contacto" },
  // { href: normalize(`${base}flores/`),      label: "Flores de Bach" }, // cuando la habilites
];

// Helper para aplicar estilos de enlace activo
const isActive = (href: string) => here === href;
---
<header class="bg-[#FFF7F1]/80 backdrop-blur supports-[backdrop-filter]:bg-[#FFF7F1]/60 border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
   
    <!-- Logo / Marca -->
    <a href={`${base}hero-b/`} class="flex items-center gap-3 font-semibold text-slate-800" aria-label="Ir al inicio">
      <Logo size="small" priority={true} />
      <span class="hidden sm:inline">Terapias Naturales - Silvia Adame</span>
      <span class="sm:hidden">Silvia Adame</span>
    </a>

    <!-- Navegación Desktop -->
    <nav class="hidden md:flex items-center gap-5 text-sm" aria-label="Principal">
      {/* @ts-ignore */}
      {links.map((l) => (
        <a
          href={l.href}
          class={`px-1 py-2 transition-colors hover:underline ${
            isActive(l.href) ? "text-slate-900 font-semibold underline" : "text-slate-700"
          }`}
          aria-current={isActive(l.href) ? "page" : undefined}
        >
          {l.label}
        </a>
      ))}
    </nav>

    <!-- Botón hamburguesa móvil -->
    <button 
      data-mobile-menu-toggle
      class="md:hidden flex flex-col items-center justify-center w-8 h-8 space-y-1 z-50 relative"
      aria-label="Abrir menú de navegación"
      aria-expanded="false"
    >
      <span class="mobile-menu-line w-6 h-0.5 bg-slate-700 transition-all duration-300 origin-center"></span>
      <span class="mobile-menu-line w-6 h-0.5 bg-slate-700 transition-all duration-300 origin-center"></span>
      <span class="mobile-menu-line w-6 h-0.5 bg-slate-700 transition-all duration-300 origin-center"></span>
    </button>
  </div>

  <!-- Menú móvil overlay -->
  <div 
    data-mobile-menu-overlay
    class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-40 opacity-0 invisible pointer-events-none transition-all duration-300 md:hidden"
  >
    <nav 
      data-mobile-menu-panel
      class="absolute top-0 right-0 h-full w-72 bg-white/95 backdrop-blur-md shadow-2xl border-l border-slate-200 transform translate-x-full transition-transform duration-300"
      aria-label="Navegación móvil"
    >
      <!-- Header del menú móvil -->
      <div class="bg-gradient-to-r from-[#3B755F] to-[#9FB8AD] px-6 py-5 text-white">
        <h2 class="text-lg font-semibold">Navegación</h2>
        <p class="text-sm opacity-90">Terapias Naturales</p>
      </div>
      
      <div class="p-6">
        {/* @ts-ignore */}
        {links.map((l) => (
          <a
            href={l.href}
            data-mobile-menu-link
            class={`block py-4 px-5 mb-3 rounded-xl text-lg font-medium transition-all duration-200 ${
              isActive(l.href) 
                ? "bg-[#3B755F] text-white shadow-lg scale-105" 
                : "text-slate-800 hover:bg-[#9FB8AD]/20 hover:text-[#3B755F] hover:scale-102"
            }`}
            aria-current={isActive(l.href) ? "page" : undefined}
          >
            {l.label}
          </a>
        ))}
      </div>
    </nav>
  </div>
</header>

<script>
  // Clase para manejar el menú móvil de forma más robusta
  class MobileMenu {
    private button: HTMLElement | null = null;
    private overlay: HTMLElement | null = null;
    private panel: HTMLElement | null = null;
    private lines: NodeListOf<HTMLElement> | null = null;
    private isOpen: boolean = false;
    private initialized: boolean = false;

    constructor() {
      this.init();
    }

    init() {
      // Prevenir doble inicialización
      if (this.initialized) return;
      
      // Buscar elementos
      this.button = document.querySelector('[data-mobile-menu-toggle]');
      this.overlay = document.querySelector('[data-mobile-menu-overlay]');
      this.panel = document.querySelector('[data-mobile-menu-panel]');
      this.lines = document.querySelectorAll('.mobile-menu-line');
      
      // Si no encontramos los elementos esenciales, salir
      if (!this.button || !this.overlay || !this.panel) {
        // Solo mostrar warning en development
        if (import.meta.env.DEV) {
          console.warn('Mobile menu: elementos no encontrados');
        }
        return;
      }
      
      this.setupEventListeners();
      this.initialized = true;
    }

    setupEventListeners() {
      if (!this.button || !this.overlay) return;

      // Click en botón hamburguesa
      this.button.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.toggle();
      });

      // Click en overlay para cerrar
      this.overlay.addEventListener('click', (e) => {
        if (e.target === this.overlay) {
          this.close();
        }
      });

      // Click en enlaces del menú
      const menuLinks = document.querySelectorAll('[data-mobile-menu-link]');
      menuLinks.forEach(link => {
        link.addEventListener('click', () => {
          this.close();
        });
      });

      // Tecla Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.isOpen) {
          this.close();
        }
      });

      // Resize: cerrar menú si se vuelve a desktop
      window.addEventListener('resize', () => {
        if (window.innerWidth >= 768 && this.isOpen) {
          this.close();
        }
      });
    }

    toggle() {
      if (this.isOpen) {
        this.close();
      } else {
        this.open();
      }
    }

    open() {
      if (!this.button || !this.overlay || !this.panel || this.isOpen) return;
      
      this.isOpen = true;
      
      // Mostrar overlay y panel
      this.overlay.classList.remove('opacity-0', 'invisible');
      this.panel.classList.remove('translate-x-full');
      this.button.setAttribute('aria-expanded', 'true');
      
      // Animar hamburguesa a X
      if (this.lines && this.lines.length >= 3) {
        this.lines[0].style.transform = 'rotate(45deg) translate(5px, 5px)';
        this.lines[1].style.opacity = '0';
        this.lines[2].style.transform = 'rotate(-45deg) translate(7px, -6px)';
      }
      
      // Bloquear scroll
      document.body.style.overflow = 'hidden';
    }

    close() {
      if (!this.button || !this.overlay || !this.panel || !this.isOpen) return;
      
      this.isOpen = false;
      
      // Ocultar overlay y panel
      this.overlay.classList.add('opacity-0', 'invisible');
      this.panel.classList.add('translate-x-full');
      this.button.setAttribute('aria-expanded', 'false');
      
      // Restaurar hamburguesa
      if (this.lines) {
        this.lines.forEach(line => {
          line.style.transform = '';
          line.style.opacity = '';
        });
      }
      
      // Restaurar scroll
      document.body.style.overflow = '';
    }

    // Método para limpiar event listeners si es necesario
    destroy() {
      if (this.isOpen) {
        this.close();
      }
      this.initialized = false;
    }
  }

  // Función para inicializar de forma segura
  function initMobileMenu() {
    // Solo inicializar si estamos en el browser y no hay ya una instancia
    if (typeof window === 'undefined') return;
    
    // Usar un namespace global para evitar múltiples instancias
    if (!(window as any).__mobileMenu) {
      (window as any).__mobileMenu = new MobileMenu();
    }
  }

  // Inicializar cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMobileMenu);
  } else {
    // DOM ya cargado
    initMobileMenu();
  }

  // Reinicializar en navegación SPA (si usas View Transitions)
  document.addEventListener('astro:page-load', initMobileMenu);
</script>

<style>
  /* Mejoras CSS para animaciones más suaves */
  [data-mobile-menu-overlay] {
    transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
  }
  
  [data-mobile-menu-panel] {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .mobile-menu-line {
    transform-origin: center;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Asegurar que el botón esté por encima del overlay */
  [data-mobile-menu-toggle] {
    position: relative;
    z-index: 51;
  }
</style>







